<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    สร้างใบสั่ง
  </title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  <!-- CSS Files -->
  <link href="assets/css/material-dashboard.css?v=2.1.0" rel="stylesheet" />
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="assets/demo/demo.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
    <script>
      var urlParams = new URLSearchParams(window.location.search);
      var username = urlParams.get('username');
      var unitNo = urlParams.get('unitno');
      var reporter = urlParams.get('reporter');
      var offenderNo = urlParams.get('offenderNo');
  
        $(function () {
          $("#header").load("header.html");
        });
  
      $(function () {
        $("#nev").load("nev.html");
      });
  
      if (typeof web3 !== 'undefined') {
  
        web3 = new Web3(web3.currentProvider);
        console.log("existing web3: provider " + web3);
        web3.eth.defaultAccount = web3.eth.accounts[0];
      }
  
      else {
  
        web3 = new Web3(new Web3.providers.HttpProvider("https://rinkeby.infura.io/g5rWkSjjhx1LPmDch30E"));
        console.log("new provider " + typeof web3);
  
      }
  
      console.log(web3.isConnected());
  
      if (web3.isConnected()) {
  
        var TrafficConstract = web3.eth.contract([{"constant":false,"inputs":[{"name":"unitNo","type":"string"}],"name":"destroyTrafficTicket","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"unitNo","type":"string"},{"name":"id","type":"string"},{"name":"new_re_name","type":"string"},{"name":"new_re_unit","type":"string"}],"name":"editReporter","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"unitNo","type":"string"},{"name":"id","type":"string"},{"name":"new_conv_personNo","type":"string"},{"name":"new_conv_na","type":"string"},{"name":"new_conv_tel","type":"string"},{"name":"new_conv_addr","type":"string"}],"name":"editConvey","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"}],"name":"getReportcasePoint","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"},{"name":"pointer","type":"uint256"}],"name":"getMapConvey","outputs":[{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"},{"name":"pointer","type":"uint256"}],"name":"getMapReporter","outputs":[{"name":"","type":"string"},{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"unitNo","type":"string"},{"name":"id","type":"string"},{"name":"new_charge","type":"string"},{"name":"new_placeOfIncident","type":"string"},{"name":"new_speedDetection","type":"string"},{"name":"new_amountOfFine","type":"uint256"}],"name":"editReportCase","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"}],"name":"getReporterPoint","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"unitNo","type":"string"},{"name":"reporterPoint","type":"uint256"},{"name":"reportcasePoint","type":"uint256"},{"name":"conveyPoint","type":"uint256"},{"name":"trafficID","type":"string"}],"name":"newTrafficTicket","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"},{"name":"id","type":"string"},{"name":"_personalid","type":"string"}],"name":"getReportCase","outputs":[{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getTotalTicket","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"re_name","type":"string"},{"name":"re_unit","type":"string"}],"name":"setReporter","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"},{"name":"ticketNo","type":"string"}],"name":"getTicket","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"unitNo","type":"string"},{"name":"charge","type":"string"},{"name":"placeOfIncident","type":"string"},{"name":"speedDetection","type":"string"},{"name":"amountOfFine","type":"uint256"}],"name":"setReport_case","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"},{"name":"id","type":"string"},{"name":"_personalid","type":"string"}],"name":"getReporter","outputs":[{"name":"","type":"string"},{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"},{"name":"pointer","type":"uint256"}],"name":"getMapReportcase","outputs":[{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"unitNo","type":"string"},{"name":"conv_persNo","type":"string"},{"name":"_plate","type":"string"},{"name":"conv_na","type":"string"},{"name":"conv_tel","type":"string"},{"name":"conv_addr","type":"string"}],"name":"setConveyanceOwner","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"},{"name":"num","type":"uint256"}],"name":"getTicketNo","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"report_unit","type":"string"}],"name":"getTotalTicketByUnit","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"}],"name":"getConveyancePoint","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"},{"name":"id","type":"string"},{"name":"_personalid","type":"string"}],"name":"getConveyance","outputs":[{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"}]);
      var ticketAddr = "0x7e1D40c317828Df9E7A481AB1A5dE09678Ec6eba";
      var traffic = TrafficConstract.at(ticketAddr);
      } else {
        console.log('not connect');
      }

      function checkID(id)
			{
			if(id.length != 13) {
        return false; 
      }

				for(i=0, sum=0; i < 12; i++)
					sum += parseFloat(id.charAt(i))*(13-i); if((11-sum%11)%10!=parseFloat(id.charAt(12)))
					
			return false; return true;}

			function checkForm()
			{ 
				if(!checkID(document.getdataform.pers_No.value)){
						$("#error").html("รหัสบัตรประชาชนไม่ถูกต้อง");
						return false;
				}
				else {
          JSalert()
        }
					
			}
    </script>
</head>

<body class="">
  <div class="wrapper ">

    <script>
      function goToDashboard() {
        window.location.replace("./dashboard.html?username=" + username + "&unitno=" + unitNo);
      }
      goToCreateTicket = () => {
        window.location.replace("./create-tf-office-info.html?username=" + username + "&unitno=" + unitNo);
      }
    
    </script>
    <!-- Navbar for header  -->
    
    
    <div class="sidebar" data-color="azure" data-background-color="white" data-image="../assets/img/">
      <!--
            Tip 1: You can change the color of the sidebar using: data-color="purple | azure | green | orange | danger"
    
            Tip 2: you can also add an image using data-image tag
        -->
      <div class="logo">
        <a href="" class="simple-text logo-normal">
          FineFine
        </a>
      </div>
     
        <div class="sidebar-wrapper">
          <ul class="nav ">
            <li class="nav-item   ">
              <a class="nav-link" id="dashboardNav" href="#" onclick="goToDashboard()">
                <i class="fa fa-clone"></i>
                <p>ใบสั่ง</p>
              </a>
            </li>
            <li class="nav-item active">
              <a class="nav-link" id="createTicketNav" href="#" onclick="goToCreateTicket()">
                <i class="fa fa-edit fa"></i>
                <p>สร้างใบสั่ง</p>
              </a>
            </li>
            <!-- <li class="nav-item ">
              <a class="nav-link" href="./ADMINmanage.html">
                <i class="fa fa-user-plus"></i>
                <p>จัดการเจ้าหน้าที่</p>
              </a>
            </li> -->
            <li class="nav-item ">
              <a class="nav-link" href="./user.html">
                <i class="material-icons">person</i>
                <p>ข้อมูลผู้ใช้</p>
              </a>
            </li>
    
            <li class="nav-item active-pro ">
              <a class="nav-link" href="">
                <i class="fa fa-sign-out"></i>
                <p>ออกจากระบบ</p>
              </a>
            </li>
          </ul>
        </div>
      
    </div>

    <div class="main-panel">
      <!-- Navbar -->
      <div id='header'></div>
      <!-- End Navbar -->
      <div class="content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header card-header-info">
                  <h4 class="card-title">สร้างใบสั่ง</h4>
                  <p class="card-category" style="color:white">ข้อมูลอ้างอิงตามเลขทะเบียนรถ</p>
                </div>
                <div class="card-body">
                  <form>
                    <div class="row">
                      <div class="col-md-2.3">
                        <div class="form-group">
                          <label class="bmd-label-floating">
                            <font size="4">เลขที่บัตรประชาชน : </font>
                          </label>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <input type="number" class="form-control" id="personalNo" name="pers_No"  required>
                        </div>
                      </div>
                      <div class="col-md-1.8">
                        <div class="form-group">
                          <label class="bmd-label-floating">
                            <font size="4">เลขทะเบียนรถ : </font>
                          </label>

                        </div>
                      </div>
                      <div class="col-md-5">
                        <div class="form-group">
                          <input type="text" class="form-control" id="plateNo"  required>
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-1.9">
                        <div class="form-group">
                          <label class="bmd-label-floating">
                            <font size="4">ชื่อ-นามสกุล : </font>
                          </label>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <input type="text" class="form-control" id="conv_name"  required>
                        </div>
                      </div>

                      <div class="col-md-2.5">
                        <div class="form-group">
                          <label class="bmd-label-floating">
                            <font size="4">เบอร์โทร : </font>
                          </label>
                        </div>
                      </div>
                      <div class="col-md-6" >
                        <div class="form-group">
                          <input type="tel" class="form-control" id="conv_tel"  required>
                        </div>
                      </div>
                    </div>
                
                <div class="row">
                  <div class="col-md-1.8">
                    <div class="form-group">
                      <label class="bmd-label-floating">
                        <font size="4">ที่อยู่ : </font>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-11">
                    <div class="form-group">
                      <input type="text" class="form-control" id="conv_addr" required>
                    </div>
                  </div>
                </div>

                <button type="button" onclick="JSalert()" class="btn btn-info pull-right"> สร้างใบสั่ง </button>
                
                <input type="" class="btn btn-info pull-right" value="ย้อนกลับ">
                <input type="reset" class="btn btn-danger pull-right" value="ยกเลิก">
                <div class="clearfix"></div>
                </form>
              </div>
            </div>
          </div>


        <!-- script notification------------------------------------------------------------------------------------------ -->

        <script src="j.js"></script>
        <link rel="stylesheet" href="c.css">
         <!-- script notification------------------------------------------------------------------------------------------ -->



        </div>
        <!--   Core JS Files   -->
        <script src="assets/js/core/jquery.min.js" type="text/javascript"></script>
        <script src="assets/js/core/popper.min.js" type="text/javascript"></script>
        <script src="assets/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
        <script src="assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>

        <!-- Chartist JS -->
        <script src="assets/js/plugins/chartist.min.js"></script>
        <!--  Notifications Plugin    -->
        <script src="assets/js/plugins/bootstrap-notify.js"></script>
        <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
        <script src="assets/js/material-dashboard.min.js?v=2.1.0" type="text/javascript"></script>
        <!-- Material Dashboard DEMO methods, don't include it in your project! -->
        <script src="assets/demo/demo.js"></script>
        <script> 

          function JSalert() {
            swal({
              title: "ยืนยันการเพิ่มข้อมูลผู้กระทำความผิด",
              text: "",
              type: "warning",
              showCancelButton: true,
              confirmButtonColor: "#DD6B55",
              confirmButtonText: "ยืนยัน",
              cancelButtonText: "ยกเลิก",
              closeOnConfirm: false,
              closeOnCancel: false
            },
              function (isConfirm) {
                if (isConfirm) {
                 console.log()
                  submitConveyance();
                }
                else {
                  swal("ยกเลิกการเพิ่มข้อมูล", "", "error");
                }
              });
          }

         submitConveyance = () => {
            traffic.setConveyanceOwner.sendTransaction(
              unitNo
              , $("#personalNo").val()
              ,  $("#plateNo").val()
              ,  $("#conv_name").val()
              , $("#conv_tel").val()
              , $("#conv_addr").val()
              , function (error, result) {
                if (!error) {

                  traffic.getConveyancePoint(unitNo, (error, res) => {
                    if (!error) {

                      let conveyNo = parseInt(res.c[0]) + 1;
                      window.location.replace("./confirm-to-createtf.html?username=" + username + "&unitno=" + unitNo + "&reporter=" + reporter+"&offenderNo="+offenderNo+"&convNo="+conveyNo);
                    }
                  })
                    }
                else {
                  alert("Insert data");
                }
              });
          }

        </script>
</body>

</html>