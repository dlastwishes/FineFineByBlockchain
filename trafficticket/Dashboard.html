<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    ใบสั่งทั้งหมด
  </title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  <!-- CSS Files -->
  <link href="assets/css/material-dashboard.css?v=2.1.0" rel="stylesheet" />
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="assets/demo/demo.css" rel="stylesheet" />
  <script src="script/startState.js"> </script>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
  <script>
    var urlParams = new URLSearchParams(window.location.search);
    var username = urlParams.get('username');
    var unitNo = urlParams.get('unitno');
    var tableCode = "";
    var index = 0;
    var page = 30;

    if (username == null) {
      alert("Error");
      window.location.replace("index.html");
    }
  
$(function () {
  $("#header").load("./header.html");
});

$(function () {
  $("#nev").load("./nev.html");
});

if (typeof web3 !== 'undefined') {

  web3 = new Web3(web3.currentProvider);
  console.log("existing web3: provider " + web3);
  web3.eth.defaultAccount = web3.eth.accounts[0];
}

else {

  web3 = new Web3(new Web3.providers.HttpProvider("https://rinkeby.infura.io/g5rWkSjjhx1LPmDch30E"));
  console.log("new provider " + typeof web3);

}

console.log(web3.isConnected());

if (web3.isConnected()) {

  var TrafficConstract = web3.eth.contract([{"constant":false,"inputs":[{"name":"unitNo","type":"string"}],"name":"destroyTrafficTicket","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"unitNo","type":"string"},{"name":"id","type":"string"},{"name":"new_conv_personNo","type":"string"},{"name":"new_conv_na","type":"string"},{"name":"new_conv_tel","type":"string"},{"name":"new_conv_addr","type":"string"}],"name":"editConvey","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"unitNo","type":"string"},{"name":"id","type":"string"},{"name":"new_charge","type":"string"},{"name":"new_placeOfIncident","type":"string"},{"name":"new_speedDetection","type":"string"},{"name":"new_amountOfFine","type":"uint256"}],"name":"editReportCase","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"unitNo","type":"string"},{"name":"id","type":"string"},{"name":"new_re_name","type":"string"},{"name":"new_re_unit","type":"string"}],"name":"editReporter","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"unitNo","type":"string"},{"name":"reporterPoint","type":"uint256"},{"name":"reportcasePoint","type":"uint256"},{"name":"conveyPoint","type":"uint256"},{"name":"trafficID","type":"string"}],"name":"newTrafficTicket","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"unitNo","type":"string"},{"name":"conv_persNo","type":"string"},{"name":"_plate","type":"string"},{"name":"conv_na","type":"string"},{"name":"conv_tel","type":"string"},{"name":"conv_addr","type":"string"}],"name":"setConveyanceOwner","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"unitNo","type":"string"},{"name":"charge","type":"string"},{"name":"placeOfIncident","type":"string"},{"name":"speedDetection","type":"string"},{"name":"amountOfFine","type":"uint256"}],"name":"setReport_case","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"re_name","type":"string"},{"name":"re_unit","type":"string"}],"name":"setReporter","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"},{"name":"id","type":"string"},{"name":"_personalid","type":"string"}],"name":"getConveyance","outputs":[{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"}],"name":"getConveyancePoint","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"},{"name":"id","type":"string"},{"name":"_personalid","type":"string"}],"name":"getReportCase","outputs":[{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"}],"name":"getReportcasePoint","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"},{"name":"id","type":"string"},{"name":"_personalid","type":"string"}],"name":"getReporter","outputs":[{"name":"","type":"string"},{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"}],"name":"getReporterPoint","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"},{"name":"ticketNo","type":"string"}],"name":"getTicket","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"unitNo","type":"string"},{"name":"num","type":"uint256"}],"name":"getTicketNo","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getTotalTicket","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"report_unit","type":"string"}],"name":"getTotalTicketByUnit","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}]);
  var ticketAddr = "0x512a7b96b3f602a7f334249234895e0f426642c4";
  var traffic = TrafficConstract.at(ticketAddr);

  var officerContract = web3.eth.contract([{ "constant": false, "inputs": [{ "name": "unitNo", "type": "string" }, { "name": "unitName", "type": "string" }, { "name": "unitAddr", "type": "string" }, { "name": "unitTel", "type": "string" }, { "name": "unitZipcode", "type": "string" }], "name": "addUnit", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "user", "type": "string" }], "name": "checkIn", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "unitNo", "type": "string" }], "name": "destroyOfficer", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "unitNo", "type": "string" }, { "name": "_usr", "type": "string" }, { "name": "_name", "type": "string" }, { "name": "_office_address", "type": "string" }, { "name": "_tel", "type": "string" }, { "name": "_zipcode", "type": "string" }], "name": "editOfficer", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_officerCreateID", "type": "string" }, { "name": "unitNo", "type": "string" }, { "name": "_usr", "type": "string" }, { "name": "_pass", "type": "string" }, { "name": "_name", "type": "string" }, { "name": "_office_address", "type": "string" }, { "name": "_tel", "type": "string" }, { "name": "_zipcode", "type": "string" }], "name": "newOfficer", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_usr", "type": "string" }], "name": "newPermission", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_usr", "type": "string" }, { "name": "_pass", "type": "string" }, { "name": "_repass", "type": "string" }], "name": "recoverUsr", "outputs": [{ "name": "", "type": "bool" }, { "name": "", "type": "string" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "payable": false, "stateMutability": "nonpayable", "type": "constructor" }, { "constant": true, "inputs": [{ "name": "unitNo", "type": "string" }, { "name": "username", "type": "string" }], "name": "getOfficerInfo", "outputs": [{ "name": "", "type": "string" }, { "name": "", "type": "string" }, { "name": "", "type": "string" }, { "name": "", "type": "string" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "unitNo", "type": "string" }], "name": "getUnitInfo", "outputs": [{ "name": "", "type": "string" }, { "name": "", "type": "string" }, { "name": "", "type": "string" }, { "name": "", "type": "string" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "_user", "type": "string" }, { "name": "_pass", "type": "string" }], "name": "login", "outputs": [{ "name": "", "type": "bool" }, { "name": "", "type": "string" }], "payable": false, "stateMutability": "view", "type": "function" }]);
  var officerAddr = "0x1f53a420d6A03Db199e6683c09DC6d5c46D5e68e";
  var officer = officerContract.at(officerAddr);

} else {
  console.log('not connect');
}

  
  
  </script>
</head>

<body onload="createDataTable(0,30)">
  <div class="wrapper card-header-info">

    <script>
      function goToDashboard() {
        window.location.replace("./dashboard.html?username=" + username + "&unitno=" + unitNo);
      }
      goToCreateTicket = () => {
        window.location.replace("./create-tf-office-info.html?username=" + username + "&unitno=" + unitNo);
      }
    
    </script>
    <!-- Navbar for header  -->
    
    
    <div class="sidebar" data-color="azure" data-background-color="white" data-image="../assets/img/">
      <!--
            Tip 1: You can change the color of the sidebar using: data-color="purple | azure | green | orange | danger"
    
            Tip 2: you can also add an image using data-image tag
        -->
      <div class="logo">
        <a href="" class="simple-text logo-normal">
          FineFine
        </a>
      </div>
     
        <div class="sidebar-wrapper">
          <ul class="nav ">
            <li class="nav-item  active ">
              <a class="nav-link" id="dashboardNav" href="#" onclick="goToDashboard()">
                <i class="fa fa-clone"></i>
                <p>ใบสั่ง</p>
              </a>
            </li>
            <li class="nav-item ">
              <a class="nav-link" id="createTicketNav" href="#" onclick="goToCreateTicket()">
                <i class="fa fa-edit fa"></i>
                <p>สร้างใบสั่ง</p>
              </a>
            </li>
            <!-- <li class="nav-item ">
              <a class="nav-link" href="./ADMINmanage.html">
                <i class="fa fa-user-plus"></i>
                <p>จัดการเจ้าหน้าที่</p>
              </a>
            </li> -->
            <li class="nav-item ">
              <a class="nav-link" href="./user.html">
                <i class="material-icons">person</i>
                <p>ข้อมูลผู้ใช้</p>
              </a>
            </li>
    
            <li class="nav-item active-pro ">
              <a class="nav-link" href="">
                <i class="fa fa-sign-out"></i>
                <p>ออกจากระบบ</p>
              </a>
            </li>
          </ul>
        </div>
      
    </div>

    <div class="main-panel">
      <!-- Init Navbar -->
      <div id='header'></div>
      <!-- End Navbar -->
      <div class="content">
        <div class="container-fluid">
          <div class="row">
            <a href="dashboard.html">
              <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                  <div class="card-header  card-header-info card-header-icon">
                    <div class="card-icon">
                      <i class="material-icons">content_copy</i>
                    </div>
                    <p class="card-category">ใบสั่งทั้งหมด</p>
                    <h3 class="card-title" id="totalTicket">
                      <small></small>
                    </h3>
                  </div>
                  <div class="card-footer">
                    <div class="stats">
                      <!-- <i class="material-icons text-danger">warning</i>
                    <a href="#pablo">Get More Space...</a> -->
                    </div>

                  </div>
            </a>
          </div>
        </div>
        <a href="dashboard-paid.html">
          <div class="col-lg-3 col-md-6 col-sm-6">
            <div class="card card-stats">
              <div class="card-header card-header-success card-header-icon">
                <div class="card-icon">
                  <i class="fa fa-edit fa fa-check-square-o"></i>
                </div>
                <p class="card-category">ใบสั่งที่จ่ายแล้ว</p>
                <h3 class="card-title">30</h3>
              </div>
              <div class="card-footer">

              </div>
        </a>
      </div>
    </div>

    <a href="dashboard-not-pay.html">
      <div class="col-lg-3 col-md-6 col-sm-6">
        <div class="card card-stats">
          <div class="card-header card-header-warning card-header-icon">

            <div class="card-icon">
              <i class="fa fa-exclamation"></i>
            </div>
            <p class="card-category">ใบสั่งที่ยังไม่จ่าย</p>
            <h3 class="card-title">20</h3>
          </div>
          <div class="card-footer">
            <!-- <div class="stats">
                    <i class="material-icons">local_offer</i> Tracked from Github
                  </div> -->
          </div>
    </a>
  </div>
  </div>
  <a href="dashboard-report.html">
    <div class="col-lg-3 col-md-6 col-sm-6">
      <div class="card card-stats">
        <div class="card-header  card-header-danger card-header-icon">
          <div class="card-icon">
            <i class="material-icons">info_outline</i>

          </div>
          <p class="card-category">ใบสั่งที่ถูกรายงาน</p>
          <h3 class="card-title">4</h3>
        </div>
        <div class="card-footer">
          <!-- <div class="stats">
                    <i class="material-icons">update</i> Just Updated
                  </div> -->
        </div>
  </a>
  </div>
  </div>
  </div>

  <div class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header card-header-info">
              <h4 class="card-title ">ใบสั่งทั้งหมด</h4>
              <!-- <p class="card-category"> Here is a subtitle for this table</p> -->
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class='table'>
                  <thead class='' style='text-align: center'>
                    <th> เลขที่ใบสั่ง </th>
                    <th> ชื่อ-นามสกุล ผู้กระทำความผิด </th>
                    <th> สถานะใบสั่ง </th>
                    <th> วัน/เวลาที่ออกใบสั่ง </th>
                    <th style='text-align: center'> ตัวเลือก</th>
                  </thead>
                  <tbody id='trafficList'>

                    <script>


                      function setData(init, desti) {

                        traffic.getTotalTicketByUnit(unitNo, (error, result) => {

                          for (let i = init; i < desti; i++) {

                            traffic.getTicketNo(unitNo, i, (error, result) => {
                              if (!error) {

                                if (result !== "") {
                                  let ticketNo, conveyName;
                                  ticketNo = result;

                                  console.log("set trafficticket to td " + i)
                                  $("#reportcase_trafficNo" + i).html(ticketNo);

                                  traffic.getTicket(unitNo, ticketNo, (error, res) => {

                                    if (!error) {
                                      console.log("conv " + i);
                                      $("#convey_name" + i).html(res);

                                      payTicket.isPay(ticketNo, (error, result) => {
                                        if (!error) {
                                          let status = "";

                                          if (result) {
                                            status = "จ่ายแล้ว";
                                          }
                                          else {
                                            status = "ยังไม่จ่าย";
                                          }
                                          console.log(status);
                                          $("#status" + i).html(status);
                                        }
                                      })

                                    }
                                  });
                                }
                              }

                            });

                          }


                        })
                      }


                      function createDataTable(init, desti) {

                        traffic.getTotalTicketByUnit(unitNo, (error, result1) => {

                          if (!error) {

                            $("#totalTicket").html(result1.c[0]);
                            page+=5;
                            for (let i = init; i < desti; i++) {

                              traffic.getTicketNo(unitNo, i, (error, res) => {

                                if (!error) {

                                  console.log(i + " res " + res)

                                  if (res !== "") {
                                    console.log("key is " + key)

                                    tableCode += "<tr style='text-align: center'>"
                                    tableCode += " <td> <label id='reportcase_trafficNo" + i + "'> </label> </td> <td> <label id='convey_name" + i + "'> </label> </td> <td> <label id='status" + i + "'> </label> </td> <td> <label id='ticketDate" + i + "'> Not Available </label> </td>"
                                    tableCode += "<td> <button type='button' rel='tooltip' title='ดูใบสั่ง' class='btn btn-danger btn-link btn-sm'> <i class='fa fa-eye'></i></button> <button type='button' rel='tooltip' title='ลบ' class='btn btn-danger btn-link btn-sm'>  <i class='material-icons'>close</i>  </button></td>"
                                    tableCode += "</tr> "
                                    console.log(page);
                                 
                                      $("#trafficList").html(tableCode);
                                    
                                    console.log("index : " + index)
                                    console.log("td for : " + i);
                                    key++;
                                  }
                                  else {
                                    console.log('not generate tr')
                                  }
                                }
                                
                                index++;
                                
                                
                              });
                            }
                           
                            setData(init, desti);
                          }
                        });
                      }


                    </script>
                  </tbody>
                </table>


                <button type="submit" class="btn btn-info pull-right" onclick="createDataTable(0,50)">ดูเพิ่ม</button>
              </div>
            </div>
          </div>
        </div>


      </div>
    </div>
    <!--   Core JS Files   -->
    <script src="assets/js/core/jquery.min.js" type="text/javascript"></script>
    <script src="assets/js/core/popper.min.js" type="text/javascript"></script>
    <script src="assets/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
    <script src="assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>

    <!--  Notifications Plugin    -->
    <script src="assets/js/plugins/bootstrap-notify.js"></script>
    <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
    <script src="assets/js/material-dashboard.min.js?v=2.1.0" type="text/javascript"></script>
    <!-- Material Dashboard DEMO methods, don't include it in your project! -->
    <script src="assets/demo/demo.js"></script>

    <script>


      $(document).ready(function () {
        // Javascript method's body can be found in assets/js/demos.js
        md.initDashboardPageCharts();

      });

    </script>
</body>

</html>